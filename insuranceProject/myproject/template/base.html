<!DOCTYPE html>
{% load static %}
{% load cloudinary_filters %}
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>{% block title %}Versicherung in Nürnberg{% endblock %}</title>
    <meta content="{% block meta_description %}Professionelle Versicherungsdienstleistungen von Alexej Kondraskov, offizieller Partner von ARAG in Nürnberg.{% endblock %}"
          name="description">
    <meta content="index, follow" name="robots">

    <!-- Canonical + CSRF -->
    <meta content="{{ csrf_token }}" name="csrf-token">
    <link href="{{ request.build_absolute_uri }}" rel="canonical">

    <!-- Fonts: preconnect + non-blocking load -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link as="style" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
          onload="this.onload=null;this.rel='stylesheet'"
          rel="preload">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    </noscript>

    <!-- Open Graph / Twitter -->
    <meta content="Versicherung in Nürnberg | Alexej Kondraskov" property="og:title">
    <meta content="ARAG Partner – Versicherung und persönliche Beratung" property="og:description">
    <meta content="https://res.cloudinary.com/du08um3mi/image/upload/v1747675280/category_images/c22aed97af71608984866e0ada609d06_zhgpua.png"
          property="og:image">
    <meta content="https://insurance-1-gt02.onrender.com" property="og:url">
    <meta content="summary_large_image" name="twitter:card">
    <meta content="https://res.cloudinary.com/du08um3mi/image/upload/v1747675280/category_images/c22aed97af71608984866e0ada609d06_zhgpua.png"
          name="twitter:image">
    <meta content="Versicherung in Nürnberg | Alexej Kondraskov" name="twitter:title">
    <meta content="ARAG Partner – Versicherung und persönliche Beratung" name="twitter:description">

    <!-- Favicons -->
    <link href="{% static 'img/apple-touch-icon.png' %}" rel="apple-touch-icon">
    <link href="{% static 'images/favicon.png' %}" rel="icon" type="image/png">


    <!-- Bootstrap CSS (оставляем блокирующим, чтобы не словить FOUC/CLS) -->
    <link crossorigin="anonymous"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
          rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" rel="stylesheet">
    <!-- Font Awesome: non-blocking -->
    <link as="style" crossorigin="anonymous"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          onload="this.onload=null;this.rel='stylesheet'" referrerpolicy="no-referrer"
          rel="preload">
    <noscript>
        <link crossorigin="anonymous"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
              referrerpolicy="no-referrer" rel="stylesheet">
    </noscript>


    <!-- Твой основной CSS: preload + обычное подключение -->
    <link as="style" href="{% static 'css/style.css' %}" rel="preload">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <style>
        /* Рисуем LCP-текст сразу системным шрифтом, потом тихо сменим на Poppins */
        .hero-section, .hero-section .lead, .hero-section h1 {
          font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
          text-rendering: optimizeLegibility;
        }
        /* Критический минимум, чтобы заголовок и лид не зависели от внешнего CSS */
        .hero-section { background:#0b0b0b; color:#fff }
        .hero-section .lead { color:#b8bcc5 }
        .highlight-text { position:relative; display:inline-block }
        .highlight-text::after {
          content:""; position:absolute; left:0; right:0; bottom:-6px; height:6px;
          background:linear-gradient(90deg,#ffcc00,#ffe866); opacity:.7; border-radius:3px;
        }
    </style>

    <!-- Хуки для страниц -->
    {% block lcp_preload %}{% endblock %}
    {% block head_extras %}{% endblock %}
</head>

<body>
{% if request.resolver_match.url_name != "lead_create" %}
{% include "navbar.html" %}
{% endif %}

<main class="main">
    {% block content %}{% endblock %}
</main>

<footer class="footer-neo" id="kontakt">
    <div class="wrap footer-neo__grid">
        <!-- Бренд + CTA -->
        <div class="footer-neo__brand">
            <a aria-label="Startseite" class="logo" href="/">
                <span aria-hidden="true" class="logo-dot"></span>
                <span>ARAG Nürnberg Süd</span>
            </a>
            <p class="footer-neo__tag muted">
                Persönliche Beratung und passgenaue Absicherung für Selbständige und Unternehmen.
            </p>
            <div class="footer-neo__cta">
                <a class="btn btn-primary" href="https://wa.me/4915773673851" rel="noopener" target="_blank">
                    <i class="fa-brands fa-whatsapp"></i> WhatsApp
                </a>
                <a class="btn btn-ghost" href="tel:+4915773673851">
                    <i class="fa-solid fa-phone"></i> Anrufen
                </a>
            </div>
        </div>

        <!-- Контакты -->
        <address class="footer-neo__contact not-italic">
            <h4>Kontakt</h4>
            <ul class="footer-neo__list">
                <li>
                    <i class="fa-solid fa-location-dot"></i>
                    <span>ARAG Nürnberg Süd, Rothenburgerstr. 245, 90439 Nürnberg</span>
                </li>
                <li>
                    <i class="fa-solid fa-phone"></i>
                    <a href="tel:+4915773673851">+49 1577 3673851</a>
                </li>
                <li>
                    <i class="fa-solid fa-envelope"></i>
                    <a href="mailto:alexej.kondraskov@arag-partner.de">alexej.kondraskov@arag-partner.de</a>
                </li>
                <li>
                    <i class="fa-solid fa-map"></i>
                    <a href="https://maps.app.goo.gl/qTMrT81MqE95Zcw57" rel="noopener" target="_blank">Standort auf
                        Karte</a>
                </li>
            </ul>
        </address>

        <!-- Быстрые ссылки -->
        <nav aria-label="Schnelle Links" class="footer-neo__links">
            <h4>Links</h4>
            <ul class="footer-neo__list">
                <li><a href="{% url 'insurance:impressum' %}">Impressum</a></li>
                <li><a href="{% url 'insurance:datenschutz' %}">Datenschutzerklärung</a></li>
                <li><a href="/#leistungen">Leistungen</a></li>
                <li><a href="/#kontakt">Kontakt</a></li>
            </ul>
        </nav>

        <!-- Соцсети -->
        <div class="footer-neo__social">
            <h4>Folgen</h4>
            <ul class="footer-neo__social-list">
                <li>
                    <a aria-label="Facebook" href="https://www.facebook.com/profile.php?id=100077205721116"
                       rel="noopener" target="_blank">
                        <i class="fa-brands fa-facebook-f"></i>
                    </a>
                </li>
                <li>
                    <a aria-label="WhatsApp" href="https://wa.me/4915773673851" rel="noopener" target="_blank">
                        <i class="fa-brands fa-whatsapp"></i>
                    </a>
                </li>
                <li>
                    <a aria-label="Maps" href="https://maps.app.goo.gl/qTMrT81MqE95Zcw57" rel="noopener"
                       target="_blank">
                        <i class="fa-solid fa-location-dot"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Нижняя плашка -->
    <div class="footer-neo__bottom">
        <div class="wrap footer-neo__bottom-inner">
            <p class="small muted">© {% now "Y" %} ARAG Nürnberg Süd · Alexej Kondraskov</p>
            <div class="footer-neo__legal">
                <a href="/impressum">Impressum</a>
                <span aria-hidden="true">•</span>
                <a href="/datenschutz">Datenschutzerklärung</a>
            </div>
        </div>
    </div>

    <!-- Cookie-Banner -->
    <div class="cookie-banner" id="cookie-banner" style="display:none;">
        <div class="wrap cookie-banner__inner">
            <p class="small">
                Wir verwenden Cookies, um die Nutzung der Website zu verbessern. <a href="/datenschutz">Datenschutzerklärung</a>.
            </p>
            <button class="btn btn-primary cookie-accept" onclick="acceptCookies()">Akzeptieren</button>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script crossorigin="anonymous" src="https://unpkg.com/htmx.org@1.9.12"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{% static 'js/script.js' %}"></script>
<script crossorigin="anonymous"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Выполняем код только после первого кадра; если есть requestIdleCallback — используем его
  function afterFirstPaint(fn){
    if ('requestIdleCallback' in window) {
      requestIdleCallback(fn, {timeout: 1500});
    } else {
      setTimeout(fn, 0);
    }
  }
</script>


<script>
    function acceptCookies() {
        localStorage.setItem('cookiesAccepted', 'true');
        document.getElementById('cookie-banner').style.display = 'none';
    }

    window.addEventListener('load', function () {
        if (!localStorage.getItem('cookiesAccepted')) {
            document.getElementById('cookie-banner').style.display = 'block';
        }
    });
</script>


<script>
    new Swiper('.leistungen-swiper', {
      slidesPerView: 1,
      spaceBetween: 20,
      breakpoints: {
        768: { slidesPerView: 2 },
        992: { slidesPerView: 3 }
      },
      pagination: { el: '.swiper-pagination', clickable: true },
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' }
    });
</script>


<script>
    (function(){
      const form  = document.getElementById('lead-wizard');
      const msg   = document.getElementById('response-message');
      const step1 = document.getElementById('step-1');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const subSel= document.getElementById('subcategory');

      function showThanks(detail){
        if(!msg) return;
        const name = detail && (detail.name || detail.full_name) ? `, ${detail.name || detail.full_name}` : '';
        msg.innerHTML = `
          <div class="alert-thanks">
            <span class="icon">✅</span>
            <div>
              <strong>Danke${name}!</strong>
              <div>Ihre Anfrage wurde gesendet. Wir melden uns in Kürze.</div>
            </div>
          </div>`;
        msg.hidden = false;
        msg.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>{ msg.hidden = true; }, 8000);
      }

      // Сервер шлёт HX-Trigger: lead:created — ловим его
      document.body.addEventListener('lead:created', function(e){
        try{ form.reset(); }catch(_){}
        if(subSel){
          subSel.innerHTML = '<option value="">Bitte zuerst eine Kategorie wählen</option>';
          subSel.disabled = true;
        }
        [step1,step2,step3].forEach(s => s && s.classList.remove('active'));
        step1?.classList.add('active');
        showThanks(e.detail || null);
      });

      // На случай HTMX без HX-Trigger (редко): ловим успешный 2xx и имитируем событие
      document.body.addEventListener('htmx:afterRequest', function(e){
        if(e.target !== form) return;
        // если сервер вернул 204 с HX-Trigger — htmx сам вызовет событие, нам делать ничего не надо
        if(e.detail.xhr.getResponseHeader('HX-Trigger')) return;
        if(e.detail.xhr.status >= 200 && e.detail.xhr.status < 300){
          try{
            const data = JSON.parse(e.detail.xhr.responseText || '{}');
            if(data && data.ok){ document.body.dispatchEvent(new CustomEvent('lead:created', {detail:data})); }
          }catch(_){}
        }
      });
    })();
</script>


<script>
    // Cookie banner logic (оставил как у тебя)
    (function(){
      window.addEventListener('load', function () {
        if (!localStorage.getItem('cookiesAccepted')) {
          document.getElementById('cookie-banner')?.style.setProperty('display','block');
        }
      });
      window.acceptCookies = function(){
        localStorage.setItem('cookiesAccepted', 'true');
        const el = document.getElementById('cookie-banner'); if(el){ el.style.display='none'; }
      };
    })();
</script>

<!-- Мастер-скрипт для формы лида -->
<script>
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('lead-wizard');
      if(!form){ console.debug('[lead] no form on this page'); return; }

      const baseApi = form.dataset.apiSubs || '/api/subcategories/';
      const step1 = document.getElementById('step-1');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const mainSel = document.getElementById('main_category');
      const subSel  = document.getElementById('subcategory');
      const hiddenMain = document.getElementById('main_slug_field');
      const hiddenSub  = document.getElementById('sub_slug_field');
      const nextToStep2 = step1?.querySelector('.next-btn');
      const nextToStep3 = step2?.querySelector('.next-btn');
      const subsCache = new Map();

      function buildApiUrl(mainId){
        try{ const u = new URL(baseApi, window.location.origin); u.searchParams.set('main', mainId); return u.toString(); }
        catch(e){ return `${baseApi}?main=${encodeURIComponent(mainId)}`; }
      }
      function goTo(id){
        [step1,step2,step3].forEach(s => s && s.classList.remove('active'));
        document.getElementById(id)?.classList.add('active');
      }
      function updateAction(){
        const mainOpt = mainSel?.options[mainSel.selectedIndex];
        const subOpt  = subSel?.options[subSel.selectedIndex];
        const mainSlug = mainOpt?.dataset.slug;
        const subSlug  = subOpt?.dataset.slug;
        if(mainSlug && subSlug){
          const url = `/${encodeURIComponent(mainSlug)}/${encodeURIComponent(subSlug)}/`;
          form.setAttribute('hx-post', url);
          form.action = url; // страховка для не-HTMX
          if(hiddenMain) hiddenMain.value = mainSlug;
          if(hiddenSub)  hiddenSub.value  = subSlug;
        } else {
          form.removeAttribute('hx-post');
          form.removeAttribute('action');
          if(hiddenMain) hiddenMain.value = '';
          if(hiddenSub)  hiddenSub.value  = '';
        }
      }
      function toggleNext1(){ if(nextToStep2) nextToStep2.disabled = !mainSel?.value; }
      function toggleNext2(){ if(nextToStep3) nextToStep3.disabled = !subSel?.value; }

      function renderSubs(data){
        if(!Array.isArray(data) || data.length === 0){
          subSel.innerHTML = '<option value="">Keine Unterkategorien</option>';
          subSel.disabled = true;
          toggleNext2(); updateAction();
          return;
        }
        subSel.innerHTML = '<option value="">Bitte wählen</option>';
        for(const item of data){
          const o = document.createElement('option');
          o.value = item.id; o.textContent = item.name; o.dataset.slug = item.slug || '';
          subSel.appendChild(o);
        }
        subSel.disabled = false;
        if(data.length === 1){
          subSel.value = data[0].id;
          subSel.dispatchEvent(new Event('change', {bubbles:true}));
        }
        toggleNext2(); updateAction();
      }

      async function fetchSubs(mainId){
        if(subsCache.has(mainId)){ renderSubs(subsCache.get(mainId)); return true; }
        subSel.setAttribute('aria-busy','true');
        subSel.innerHTML = '<option value="">Lade…</option>';
        subSel.disabled = true;
        try{
          const url = buildApiUrl(mainId);
          const res = await fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' }, credentials: 'same-origin' });
          if(!res.ok){
            subSel.innerHTML = '<option value="">Fehler beim Laden</option>'; subSel.disabled = true; toggleNext2(); updateAction(); return false;
          }
          const data = await res.json();
          subsCache.set(mainId, data);
          renderSubs(data);
          return Array.isArray(data) && data.length > 0;
        }catch(err){
          console.error('[lead] subs error:', err);
          subSel.innerHTML = '<option value="">Fehler beim Laden</option>';
          subSel.disabled = true; toggleNext2(); updateAction();
          return false;
        }finally{ subSel.removeAttribute('aria-busy'); }
      }

      // Навигация по шагам
      form.addEventListener('click', async (e) => {
        const next = e.target.closest('.next-btn');
        const prev = e.target.closest('.prev-btn');

        if(next){
          const target = next.getAttribute('data-next');
          if(!target) return;

          if(target === '#step-2'){
            const id = mainSel?.value;
            if(!id){ alert('Bitte eine Kategorie wählen.'); return; }
            goTo('step-2');
            subSel.innerHTML = '<option value="">Lade…</option>';
            subSel.disabled = true;
            subSel.focus();
            fetchSubs(id);
            return;
          }
          if(target === '#step-3'){
            if(!subSel.value){ alert('Bitte eine Unterkategorie wählen.'); return; }
            goTo('step-3');
            return;
          }
        }

        if(prev){
          const target = prev.getAttribute('data-prev');
          if(target) goTo(target.substring(1));
        }
      });

      // Слушатели селектов
      mainSel?.addEventListener('change', (e) => {
        const id = e.target.value;
        toggleNext1();
        subSel.innerHTML = '<option value="">Bitte zuerst eine Kategorie wählen</option>';
        subSel.disabled = true;
        updateAction(); toggleNext2();
        if(step2?.classList.contains('active') && id){
          subSel.innerHTML = '<option value="">Lade…</option>';
          subSel.disabled = true;
          fetchSubs(id).then(()=> subSel.focus());
        }
      });
      subSel?.addEventListener('change', () => { toggleNext2(); updateAction(); });

      // Сабмит: ВСЕГДА перехватываем, сами решаем чем отправлять
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        updateAction();
        const url = form.getAttribute('hx-post');
        if(!url){ alert('Bitte Kategorie und Unterkategorie wählen.'); return; }

        // HTMX-путь
        if(window.htmx && typeof htmx.ajax === 'function'){
          try{
            await htmx.ajax('POST', url, {
              source: form,
              target: form,
              swap: 'none',
              values: new FormData(form),
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            // если сервер вернул 204 с HX-Trigger — дальше всё сделает слушатель
            // подстраховка: если триггера нет, сами сэмулируем "lead:created"
            setTimeout(() => {
              const shown = document.querySelector('.alert-thanks');
              if(!shown){
                document.body.dispatchEvent(new CustomEvent('lead:created', { detail: {} }));
              }
            }, 50);
            return;
          }catch(err){
            console.error('[lead] htmx.ajax error', err);
          }
        }

        // Фолбэк: fetch
        try{
          const fd = new FormData(form);
          const res = await fetch(url, { method:'POST', body:fd, headers:{ 'X-Requested-With':'XMLHttpRequest' } });
          if(res.ok){
            let detail = {};
            try{ const j = await res.json(); if(j && j.ok){ detail = j; } }catch(_){}
            document.body.dispatchEvent(new CustomEvent('lead:created', { detail }));
          } else {
            let msg = 'Fehler beim Senden. Versuchen Sie es später erneut.';
            try{ const j = await res.json(); if(j && j.errors){ msg = 'Bitte prüfen Sie die Eingaben.'; } }catch(_){}
            alert(msg);
          }
        }catch(err){
          console.error('[lead] submit fetch error', err);
          alert('Netzwerkfehler. Versuchen Sie es später erneut.');
        }
      });

      // Блок Enter на шагах 1–2
      form.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          const active = [step1,step2,step3].find(s => s && s.classList.contains('active'));
          if(active && active.id !== 'step-3'){ e.preventDefault(); }
        }
      });

      // Инициализация
      toggleNext1(); toggleNext2(); updateAction();

      // Диагностика HTMX
      document.body.addEventListener('htmx:responseError', e => console.error('[htmx] error', e));
      console.debug('[lead] ready', { api: baseApi, htmx: !!window.htmx });
    });
</script>

<!-- Показ благодарности по событию от сервера или фолбэка -->
<script>
    (function(){
      const form  = document.getElementById('lead-wizard');
      const msg   = document.getElementById('response-message');
      const step1 = document.getElementById('step-1');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const subSel= document.getElementById('subcategory');

      function showThanks(detail){
        if(!msg) return;
        const name = detail && (detail.name || detail.full_name) ? `, ${detail.name || detail.full_name}` : '';
        msg.innerHTML = `
          <div class="alert-thanks">
            <span class="icon">✅</span>
            <div>
              <strong>Danke${name}!</strong>
              <div>Ihre Anfrage wurde gesendet. Wir melden uns in Kürze.</div>
            </div>
          </div>`;
        msg.hidden = false;
        msg.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>{ msg.hidden = true; }, 8000);
      }

      document.body.addEventListener('lead:created', function(e){
        try{ form?.reset(); }catch(_){}
        if(subSel){
          subSel.innerHTML = '<option value="">Bitte zuerst eine Kategorie wählen</option>';
          subSel.disabled = true;
        }
        [step1,step2,step3].forEach(s => s && s.classList.remove('active'));
        step1?.classList.add('active');
        showThanks(e.detail || null);
      });
    })();
</script>



</body>
</html>