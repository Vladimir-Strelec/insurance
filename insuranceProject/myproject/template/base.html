<!DOCTYPE html>
{% load static %}
{% load cloudinary_filters %}
<html lang="de">
<head>
    <meta charset="UTF-8">

    <title>{% block title %}Versicherung in Nürnberg{% endblock %}</title>
    <meta content="{% block meta_description %}Professionelle Versicherungsdienstleistungen von Alexej Kondraskov, offizieller Partner von ARAG in Nürnberg.{% endblock %}"
          name="description">
    <meta content="index, follow" name="robots">


    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" rel="stylesheet">
    <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          referrerpolicy="no-referrer" rel="stylesheet">

    <meta content="{{ csrf_token }}" name="csrf-token">
    <link href="{{ request.build_absolute_uri }}" rel="canonical">

    <meta content="Versicherung in Nürnberg | Alexej Kondraskov" property="og:title">
    <meta content="ARAG Partner – Versicherung und persönliche Beratung" property="og:description">
    <meta content="https://res.cloudinary.com/du08um3mi/image/upload/v1747675280/category_images/c22aed97af71608984866e0ada609d06_zhgpua.png"
          property="og:image">
    <meta content="https://insurance-1-gt02.onrender.com" property="og:url">
    <meta content="summary_large_image" name="twitter:card">
    <meta content="https://res.cloudinary.com/du08um3mi/image/upload/v1747675280/category_images/c22aed97af71608984866e0ada609d06_zhgpua.png"
          name="twitter:image">
    <meta content="Versicherung in Nürnberg | Alexej Kondraskov" name="twitter:title">
    <meta content="ARAG Partner – Versicherung und persönliche Beratung" name="twitter:description">
    <link href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" rel="stylesheet">

    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="{% static 'img/apple-touch-icon.png' %}" rel="apple-touch-icon">
    <link href="{% static 'images/favicon.png' %}" rel="icon" type="image/png">
    <link href="{% static 'css/style.css' %}" rel="stylesheet" type="text/css">
</head>

<body>
{% if request.resolver_match.url_name != "lead_create" %}
{% include "navbar.html" %}
{% endif %}


<main class="main">
    {% block content %}
    {% endblock %}
</main>

<footer class="footer">
    <section id="kontakt" style="color: #ffcc00; padding: 2rem 1rem;">
        <div style="max-width: 960px; margin: auto;">
            <p><strong>Adresse:</strong> ARAG Nürnberg Süd, Rothenburgerstr. 245, 90439 Nürnberg, Deutschland</p>
            <p><strong>Telefon:</strong> <a href="tel:+4915773673851" style="color: #ffcc00; text-decoration: none;">+49
                1577 3673851</a></p>
            <p><strong>E-Mail:</strong> <a href="mailto:alexej.kondraskov@arag-partner.de"
                                           style="color: #ffcc00; text-decoration: none;">alexej.kondraskov@arag-partner.de</a>
            </p>

            <div style="margin-top: 1rem; font-size: 1.5rem;">
                <div style="margin-top: 1rem; font-size: 1.7rem;">
                    <a href="https://wa.me/4915773673851" rel="noopener noreferrer" style="color: #ffcc00;"
                       target="_blank" title="WhatsApp">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                </div>
                <a href="https://www.facebook.com/profile.php?id=100077205721116"
                   rel="noopener noreferrer" style="margin-right: 1rem; color: #ffcc00;" target="_blank"
                   title="Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a aria-label="Standort auf Google Maps öffnen" href="https://maps.app.goo.gl/qTMrT81MqE95Zcw57" rel="noopener noreferrer"
                   style="display: inline-block; text-decoration: none;" target="_blank">
                    <svg fill="none" height="40" stroke="#ffcc00" stroke-linecap="round" stroke-linejoin="round"
                         stroke-width="2" viewBox="0 0 24 24" width="40" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </a>
            </div>
        </div>
    </section>

    <!-- Cookie-Banner -->
    <div id="cookie-banner"
         style="position: fixed; bottom: 0; left: 0; right: 0; background: #222; color: #fff; padding: 1rem; z-index: 9999; display: none;">
        <div style="max-width: 960px; margin: auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <p style="margin: 0;">Wir verwenden Cookies, um die Nutzung der Website zu verbessern. <a href="datenschutz"
                                                                                                      style="color: #ffcc00;">Datenschutzerklärung</a>.
            </p>
            <button onclick="acceptCookies()"
                    style="background: #ffcc00; border: none; padding: 0.5rem 1rem; cursor: pointer;">Akzeptieren
            </button>
        </div>
    </div>
    <a href="#">Impressum</a> |
    <a href="#">Datenschutzerklärung</a>
</footer>

<!-- Scripts -->

<script crossorigin="anonymous"
        integrity="sha384-MQ7lN9c4b7l7C8Wq7iJ3pQKx6b8Cj5m0h5h2z3lw7pYqA7w9Wg2X0yQqT0yQqJ9R"
        src="https://unpkg.com/htmx.org@1.9.12"></script>
<script src="{% static 'js/script.js' %}"></script>
<script crossorigin="anonymous"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // Scroll to top on load
    window.onload = function () {
        window.scrollTo(0, 0);
    };

    // Cookie banner logic
    function acceptCookies() {
        localStorage.setItem('cookiesAccepted', 'true');
        document.getElementById('cookie-banner').style.display = 'none';
    }

    window.addEventListener('load', function () {
        if (!localStorage.getItem('cookiesAccepted')) {
            document.getElementById('cookie-banner').style.display = 'block';
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
    new Swiper('.leistungen-swiper', {
      slidesPerView: 1,
      spaceBetween: 20,
      breakpoints: {
        768: { slidesPerView: 2 },
        992: { slidesPerView: 3 }
      },
      pagination: { el: '.swiper-pagination', clickable: true },
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('lead-wizard');
      if(!form){ console.warn('[lead] form not found'); return; }

      const baseApi = form.dataset.apiSubs || '/api/subcategories/';
      const step1 = document.getElementById('step-1');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const mainSel = document.getElementById('main_category');
      const subSel  = document.getElementById('subcategory');
      const hiddenMain = document.getElementById('main_slug_field');
      const hiddenSub  = document.getElementById('sub_slug_field');
      const nextToStep2 = step1?.querySelector('.next-btn');
      const nextToStep3 = step2?.querySelector('.next-btn');
      const subsCache = new Map();

      function buildApiUrl(mainId){
        try{ const u = new URL(baseApi, window.location.origin); u.searchParams.set('main', mainId); return u.toString(); }
        catch(e){ return `${baseApi}?main=${encodeURIComponent(mainId)}`; }
      }
      function goTo(id){
        [step1,step2,step3].forEach(s => s && s.classList.remove('active'));
        document.getElementById(id)?.classList.add('active');
      }
      function updateAction(){
      const mainOpt = mainSel?.options[mainSel.selectedIndex];
      const subOpt  = subSel?.options[subSel.selectedIndex];
      const mainSlug = mainOpt?.dataset.slug;
      const subSlug  = subOpt?.dataset.slug;
      if(mainSlug && subSlug){
        const url = `/${encodeURIComponent(mainSlug)}/${encodeURIComponent(subSlug)}/`;
        form.setAttribute('hx-post', url);
        form.action = url;            // ← добавили
        if(hiddenMain) hiddenMain.value = mainSlug;
        if(hiddenSub)  hiddenSub.value  = subSlug;
      } else {
        form.removeAttribute('hx-post');
        form.removeAttribute('action'); // ← добавили
        if(hiddenMain) hiddenMain.value = '';
        if(hiddenSub)  hiddenSub.value  = '';
      }
        }
      function toggleNext1(){ if(nextToStep2) nextToStep2.disabled = !mainSel?.value; }
      function toggleNext2(){ if(nextToStep3) nextToStep3.disabled = !subSel?.value; }

      function renderSubs(data){
        if(!Array.isArray(data) || data.length === 0){
          subSel.innerHTML = '<option value="">Keine Unterkategorien</option>';
          subSel.disabled = true;
          toggleNext2(); updateAction();
          return;
        }
        subSel.innerHTML = '<option value="">Bitte wählen</option>';
        for(const item of data){
          const o = document.createElement('option');
          o.value = item.id; o.textContent = item.name; o.dataset.slug = item.slug || '';
          subSel.appendChild(o);
        }
        subSel.disabled = false;
        if(data.length === 1){
          subSel.value = data[0].id;
          subSel.dispatchEvent(new Event('change', {bubbles:true}));
        }
        toggleNext2(); updateAction();
      }

      async function fetchSubs(mainId){
        if(subsCache.has(mainId)){ renderSubs(subsCache.get(mainId)); return true; }
        subSel.setAttribute('aria-busy','true');
        subSel.innerHTML = '<option value="">Lade…</option>';
        subSel.disabled = true;
        try{
          const url = buildApiUrl(mainId);
          console.debug('[lead] GET', url);
          const res = await fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' }, credentials: 'same-origin' });
          if(!res.ok){ const txt = await res.text(); console.error('[lead] subs failed:', res.status, txt);
            subSel.innerHTML = '<option value="">Fehler beim Laden</option>'; subSel.disabled = true; toggleNext2(); updateAction(); return false; }
          const data = await res.json();
          subsCache.set(mainId, data);
          renderSubs(data);
          return Array.isArray(data) && data.length > 0;
        }catch(err){
          console.error('[lead] subs error:', err);
          subSel.innerHTML = '<option value="">Fehler beim Laden</option>';
          subSel.disabled = true; toggleNext2(); updateAction();
          return false;
        }finally{ subSel.removeAttribute('aria-busy'); }
      }

      // Переходы по шагам
      form.addEventListener('click', async (e) => {
        const next = e.target.closest('.next-btn');
        const prev = e.target.closest('.prev-btn');

        if(next){
          const target = next.getAttribute('data-next');
          if(!target) return;

          if(target === '#step-2'){
            const id = mainSel?.value;
            if(!id){ alert('Bitte eine Kategorie wählen.'); return; }
            goTo('step-2');
            subSel.innerHTML = '<option value="">Lade…</option>';
            subSel.disabled = true;
            subSel.focus();
            fetchSubs(id);
            return;
          }
          if(target === '#step-3'){
            if(!subSel.value){ alert('Bitte eine Unterkategorie wählen.'); return; }
            goTo('step-3');
            return;
          }
        }

        if(prev){
          const target = prev.getAttribute('data-prev');
          if(target) goTo(target.substring(1));
        }
      });

      // Изменения выборов
      mainSel?.addEventListener('change', (e) => {
        const id = e.target.value;
        toggleNext1();
        subSel.innerHTML = '<option value="">Bitte zuerst eine Kategorie wählen</option>';
        subSel.disabled = true;
        updateAction(); toggleNext2();
        if(step2?.classList.contains('active') && id){
          subSel.innerHTML = '<option value="">Lade…</option>';
          subSel.disabled = true;
          fetchSubs(id).then(()=> subSel.focus());
        }
      });
      subSel?.addEventListener('change', () => { toggleNext2(); updateAction(); });

      // Сабмит: фолбэк на случай отсутствия HTMX
      form.addEventListener('submit', (e) => {
        updateAction();
        const url = form.getAttribute('hx-post');
        if(!url){
          e.preventDefault();
          alert('Bitte Kategorie und Unterkategorie wählen.');
          return;
        }
        if(!window.htmx){
          // HTMX не подключён: шлём обычный POST
          form.action = url;
          form.method = 'post';
          // не предотвращаем — пусть уйдёт стандартный POST
        } else {
          // HTMX сам перехватит hx-post и отправит AJAX
        }
      });

      // Блок Enter на шагах 1–2
      form.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          const active = [step1,step2,step3].find(s => s && s.classList.contains('active'));
          if(active && active.id !== 'step-3'){ e.preventDefault(); }
        }
      });

      // init
      toggleNext1(); toggleNext2(); updateAction();
      console.debug('[lead] ready', { api: baseApi, htmx: !!window.htmx });
    });

</script>

<script>
    (function(){
      const form  = document.getElementById('lead-wizard');
      const msg   = document.getElementById('response-message');
      const step1 = document.getElementById('step-1');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const subSel= document.getElementById('subcategory');

      function showThanks(detail){
        if(!msg) return;
        const name = detail && (detail.name || detail.full_name) ? `, ${detail.name || detail.full_name}` : '';
        msg.innerHTML = `
          <div class="alert-thanks">
            <span class="icon">✅</span>
            <div>
              <strong>Danke${name}!</strong>
              <div>Ihre Anfrage wurde gesendet. Wir melden uns in Kürze.</div>
            </div>
          </div>`;
        msg.hidden = false;
        msg.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>{ msg.hidden = true; }, 8000);
      }

      // Сервер шлёт HX-Trigger: lead:created — ловим его
      document.body.addEventListener('lead:created', function(e){
        try{ form.reset(); }catch(_){}
        if(subSel){
          subSel.innerHTML = '<option value="">Bitte zuerst eine Kategorie wählen</option>';
          subSel.disabled = true;
        }
        [step1,step2,step3].forEach(s => s && s.classList.remove('active'));
        step1?.classList.add('active');
        showThanks(e.detail || null);
      });

      // На случай HTMX без HX-Trigger (редко): ловим успешный 2xx и имитируем событие
      document.body.addEventListener('htmx:afterRequest', function(e){
        if(e.target !== form) return;
        // если сервер вернул 204 с HX-Trigger — htmx сам вызовет событие, нам делать ничего не надо
        if(e.detail.xhr.getResponseHeader('HX-Trigger')) return;
        if(e.detail.xhr.status >= 200 && e.detail.xhr.status < 300){
          try{
            const data = JSON.parse(e.detail.xhr.responseText || '{}');
            if(data && data.ok){ document.body.dispatchEvent(new CustomEvent('lead:created', {detail:data})); }
          }catch(_){}
        }
      });
    })();
</script>


</body>
</html>